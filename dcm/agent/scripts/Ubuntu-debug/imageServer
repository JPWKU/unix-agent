#!/bin/bash

# Copyright 2008-2009 enStratus Networks LLC
#
# makeImage - Shell script called to bundle an image and upload it to Amazon S3
# 
# This software is part of the enStratus Cloud Management System. Only 
# authorized licensees of enStratus may use this software and only
# in the context of enStratus-managed virtual servers and machine images. 
# Unauthorized copying or distribution of this software is strictly prohibited.
# Authorized licensees may copy this software onto any machine images
# and/or virtual hosts being managed by the enStratus system as needed.
#
# FUNCTION
# enStratus will call this script to bundle your root volume as an Amazon Machine Image
# and upload it to Amazon S3.
#
# HOW TO EXTEND THIS SCRIPT (aka DO NOT EDIT THIS SCRIPT)
# You can extend or replace this script by setting up your own executables in /enstratus/custom/bin:
# * /enstratus/custom/bin/makeImage - if exists, will completely replace this script
# * /enstratus/custom/bin/makeImage-pre - if exists, will be executed before this script
# * /enstratus/custom/bin/makeImage-post - if exists, will be executed after this script
# Your replacement commands will be called with the same arguments in the same order as
# this script.

set -u

EC2_HOME=/usr

LOGGER=/enstratus/bin/log
logTag="imageServer"

$LOGGER -t "$logTag" $0 $@
$LOGGER -t "$logTag" -v "CUSTOMER_ID=${1} SERVER_ID=${2} BUNDLE=${3} IMAGE_NAME=${4} ARCHITECTURE=${5} ACCOUNT=${6} TARGET=${7} ACCESS_KEY=${8} SECRET_KEY=${9} CERTFILE=${10} PKFILE=${11}"

if [ $# -lt 11 ] ; then
   $LOGGER -t "$logTag" "Syntax: imageServer CUSTID SVRID BUNDLE IMGNAME ARCHITECTURE ACCOUNT TARGET ACCESSKEY SECRETKEY CERTFILE PKFILE"
   $LOGGER -t "$logTag" "exit 1" at Line \#$LINENO; exit 1
fi

BASENAME=`basename $0`
CUSTOM="/enstratus/custom/bin/$BASENAME"

if [ -x ${CUSTOM} ] ; then
	${CUSTOM} "$@" 2>&1 | $LOGGER -t "$logTag"
	$LOGGER -t "$logTag" "exit $?" at Line \#$LINENO; exit $?
fi

if [ -x ${CUSTOM}-pre ] ; then
	${CUSTOM}-pre "$@" 2>&1 | $LOGGER -t "$logTag"
	if [ $? != 0 ] ; then
		$LOGGER -t "$logTag" "exit $?" at Line \#$LINENO; exit $?
	fi
fi

#if [ -d /usr/lib/site_ruby ] ; then
#	export RUBYLIB=/usr/lib/site_ruby
#elif [ -d /usr/lib/ruby/site_ruby ] ; then
#	export RUBYLIB=/usr/lib/ruby/site_ruby
#fi

# This is where enStratus-rolled images live
if [ -x /opt/ec2-ami-tools/current/bin/ec2-bundle-vol ] ; then
	export EC2BIN=/opt/ec2-ami-tools/current/bin
	export EC2_AMITOOL_HOME=/opt/ec2-ami-tools/current
elif [ -x /usr/local/bin/ec2-bundle-vol ] ; then
	export EC2BIN=/usr/local/bin
elif [ -x /home/ec2/bin/ec2-bundle-vol ] ; then
	export EC2BIN=/home/ec2/bin
elif [ -x /opt/aws/amitools/ec2/bin/ec2-bundle-vol ] ; then
	# Amazon Linux
	export EC2_AMITOOL_HOME=/opt/aws/amitools/ec2
	export EC2_HOME=/opt/aws/apitools/ec2
	export EC2BIN=${EC2_AMITOOL_HOME}/bin
else
	export EC2BIN="$EC2_HOME"/bin
fi

CUSTOMER_ID=${1}
SERVER_ID=${2}
BUNDLE=${3}
IMAGE_NAME=${4}
ARCHITECTURE=${5}
ACCOUNT=${6}
TARGET=${7}
ACCESS_KEY=${8}
SECRET_KEY=${9}
CERTFILE=${10}
PKFILE=${11}

if [ -d "$TARGET" ]; then
   rm -rf "$TARGET"
fi

mkdir -p "$TARGET"

$LOGGER -t "$logTag" "Starting image bundle process..."

if [ ! -f "$PKFILE" ] ; then
	$LOGGER -t "$logTag" "No $PKFILE"
	$LOGGER -t "$logTag" "exit 10" at Line \#$LINENO; exit 10
fi

if [ ! -f "$CERTFILE" ] ; then
	$LOGGER -t "$logTag" "No $CERTFILE"	
	$LOGGER -t "$logTag" "exit 11" at Line \#$LINENO; exit 11
fi

# Added -i due to https://forums.aws.amazon.com/thread.jspa?messageID=341020
# otherwise you'll have to do the following at first boot (on ubuntu):
# apt-get install --force-yes -q -y --force-reinstall true ubuntu-keyring
# followed by: apt-get update

# This is a little more complicated than it needs to be but we need to
# account for different versions of ec2-ami-tools
# First we try with the `-i` option. If that fails, we fall back to no `-i`.

# The reason for the `-i` option is that ec2-bundle-vol started
# excluding pems and gpg certs thus breaking reimaging from an
# already imaged instance

# First we build the list of files we want to keep.
# We're only going to trust /usr,/var/, /opt and /etc
KEEP_FILES=`find /usr /var /etc /opt -name '*.crt' -o -name '*.gpg' -o -name '*.pem' | tr '\n' ','`
sudo -E ${EC2BIN}/ec2-bundle-vol -i $KEEP_FILES -d ${TARGET} -k ${PKFILE} -c ${CERTFILE} -u ${ACCOUNT} -p ${IMAGE_NAME} -r ${ARCHITECTURE} --batch > /mnt/tmp/bundle.log 2>&1

if [ $? != 0 ] ; then
	$LOGGER -t "$logTag" "Bundle failed with exit code $?"
	$LOGGER -t "$logTag" "exit 12" at Line \#$LINENO; exit 12
fi

if [ -x ${CUSTOM}-post ] ; then
	${CUSTOM}-post "$@" 2>&1 | $LOGGER -t "$logTag"
fi

$LOGGER -t "$logTag" "Bundle complete."
$LOGGER -t "$logTag" "exit $?" at Line \#$LINENO; exit $?

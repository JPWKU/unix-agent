#!/bin/bash

# Copyright 2011 enStratus Networks LLC
#
# removeUser - Removes shell access for the specified user.
# 
# This software is part of the enStratus Cloud Management System. Only 
# authorized licensees of enStratus may use this software and only
# in the context of enStratus-managed virtual servers and machine images. 
# Unauthorized copying or distribution of this software is strictly prohibited.
# Authorized licensees may copy this software onto any machine images
# and/or virtual hosts being managed by the enStratus system as needed.
#
# FUNCTION
# Grants the specified user shell access to the server.
#
# HOW TO EXTEND THIS SCRIPT (aka DO NOT EDIT THIS SCRIPT)
# You can extend or replace this script by setting up your own executables in /enstratus/custom/bin:
# * /enstratus/custom/bin/addUser - if exists, will completely replace this script
# * /enstratus/custom/bin/addUser-pre - if exists, will be executed before this script
# * /enstratus/custom/bin/addUser-post - if exists, will be executed after this script
# Your custom commands will be called with the same arguments in the same order as
# this script.

set -u

logTag="removeUser"
LOGGER=/enstratus/bin/log

if [ $# -lt 1 ] ; then
   $LOGGER -t "$logTag" Syntax: removeUser USER_ID
   $LOGGER -t "$logTag" "exit 1" at Line \#$LINENO; exit 1
fi

$LOGGER -t "$logTag" "$0 $@"
$LOGGER -t "$logTag" -v "UserID: ${1}"

USERDEL=/usr/sbin/userdel

if [ -f /usr/sbin/userdel ] ; then
	USERDEL=/usr/sbin/userdel
elif [ -f /usr/local/sbin/userdel ] ; then
	USERDEL=/usr/local/sbin/userdel
else
	$LOGGER -t "$logTag" Could not find user remove command 
	$LOGGER -t "$logTag" "exit 80" at Line \#$LINENO; exit 80
fi

BASENAME=`basename $0`
CUSTOM="/enstratus/custom/bin/$BASENAME"

if [ -x ${CUSTOM} ] ; then
	${CUSTOM} "$@" 2>&1 | $LOGGER -t "$logTag"
	$LOGGER -t "$logTag" "exit $?" at Line \#$LINENO; exit $?
fi

USER_ID=${1}

if [ -x ${CUSTOM}-pre ] ; then
	${CUSTOM}-pre "$@" 2>&1 | $LOGGER -t "$logTag"
	if [ $? != 0 ] ; then
		$LOGGER -t "$logTag" "exit $?" at Line \#$LINENO; exit $?
	fi
fi

id "$USER_ID" 2> /dev/null
if [ $? != 0 ] ; then
	$LOGGER -t "$logTag" "exit 0" at Line \#$LINENO; exit 0
fi

sudo "$USERDEL" -f -r "$USER_ID" 2>&1 | $LOGGER -t "$logTag"

if [ -x ${CUSTOM}-post ] ; then
	${CUSTOM}-post "$@" 2>&1 | $LOGGER -t "$logTag"
fi

$LOGGER -t "$logTag" "exit $?" at Line \#$LINENO; exit $?

# -*- mode: ruby -*-
# vi: set ft=ruby :

# env vars for vb provider
$ES_STORAGE_CREDS = ENV['DCM_AGENT_STORAGE_CREDS'] || "null"
$DCM_AGENT_VERSION = ENV['DCM_AGENT_VERSION'] || "null"
$DCM_AGENT_PKG = ENV['AGENT_BASE_URL'] || "null"
$DCM_AGENT_TEST_LOCAL = ENV['DCM_AGENT_TEST_LOCAL'] || "null"

machine_config = {

  "vb" => {
    "default-ubuntu-1004-i386" => {
      :hostname => "ubuntu-1004-i386",
      :box => "opscode-ubuntu-10.04-i386",
      :box_url => "http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_ubuntu-10.04-i386_chef-provisionerless.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/ubuntu-1004-i386.disk"
      },
    "default-ubuntu-1004" => {
      :hostname => "ubuntu-1004",
      :box => "opscode-ubuntu-10.04",
      :box_url => "https://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_ubuntu-10.04_chef-provisionerless.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/ubuntu-1004.disk"
      },
    'default-ubuntu-1204' => {
      :hostname => "ubuntu-1204",
      :box => "opscode-ubuntu-12.04",
      :box_url => "https://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_ubuntu-12.04_chef-provisionerless.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/ubuntu-1204.disk"
      },
    'default-ubuntu-1204-i386' => {
      :hostname => "ubuntu-1204-i386",
      :box => "opscode-ubuntu-12.04-i386",
      :box_url => "http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_ubuntu-12.04-i386_chef-provisionerless.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/ubuntu-1204-i386.disk"
      },
    'default-ubuntu-1404' => {
      :hostname => "ubuntu-1404",
      :box => "opscode-ubuntu-14.04",
      :box_url => "http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_ubuntu-14.04_chef-provisionerless.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/ubuntu-1404.disk"
      },
    'default-ubuntu-1404-i386' => {
      :hostname => "ubuntu-1404-i386",
      :box => "default-ubuntu-14.04-i386",
      :box_url => "https://s3.amazonaws.com/dcmagentboxes/default-ubuntu-1404-i386.agent.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/ubuntu-1404-i386.disk"
      },
    'default-debian-608' => {
      :hostname => "debian-608",
      :box => "default-debian-608",
      :box_url => "http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_debian-6.0.8_chef-provisionerless.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/default-debian-608.disk"
      },
    'default-debian-608-i386' => {
      :hostname => "debian-608-i386",
      :box => "default-debian-608-i386",
      :box_url => "http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_debian-6.0.8-i386_chef-provisionerless.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/default-debian-608-i386.disk"
      },
    'default-debian-75' => {
      :hostname => "debian-75",
      :box => "default-debian-75",
      :box_url => "https://vagrantcloud.com/puphpet/boxes/debian75-x64/versions/2/providers/virtualbox.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/default-debian-75.disk"
      },
    'default-debian-75-i386' => {
      :hostname => "debian-75-i386",
      :box => "default-debian-75-i386",
      :box_url => "https://vagrantcloud.com/puphpet/boxes/debian75-x32/versions/2/providers/virtualbox.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/default-debian-75-i386.disk"
      },
    'default-centos-65-i386' => {
      :hostname => "centos-65-i386",
      :box => "opscode-centos-6.5-i386",
      :box_url => "http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_centos-6.5-i386_chef-provisionerless.box",
      :second_controller => "IDE Controller",
      :disk_path => "/tmp/centos-64-i386.disk"
      }
  },
  "aws" => {
    "default-ubuntu-1004-i386" => {
      :hostname => "ubuntu-1004-i386",
      :box => "default-ubuntu-1004-i386",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-10e41778",
      :ssh_username => "ubuntu"
      },
    "default-ubuntu-1004" => {
      :hostname => "ubuntu-1004",
      :box => "default-ubuntu-1004",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-0baf7662",
      :ssh_username => "ubuntu"
      },
    "default-ubuntu-1204" => {
      :hostname => "ubuntu-1204",
      :box => "default-ubuntu-1204",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-fd20ad94",
      :ssh_username => "ubuntu"
      },
    "default-ubuntu-1204-i386" => {
      :hostname => "ubuntu-1204-i386",
      :box => "default-ubuntu-1204-i386",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-f87dba90",
      :ssh_username => "ubuntu"
      },
    "default-ubuntu-1404" => {
      :hostname => "ubuntu-1404",
      :box => "default-ubuntu-1404",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-018c9568",
      :ssh_username => "ubuntu"
      },
    "default-ubuntu-1404-i386" => {
      :hostname => "ubuntu-1404-i386",
      :box => "default-ubuntu-1404-i386",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-384d8450",
      :ssh_username => "ubuntu"
      },
    "default-debian-6.0" => {
      :hostname => "debian-6.0",
      :box => "default-debian-6.0",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-5e12dc36",
      :ssh_username => "admin"
      },
    "default-debian-6.0-i386" => {
      :hostname => "debian-6.0-i386",
      :box => "default-debian-6.0-i386",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-5614da3e",
      :ssh_username => "admin"
      },
    "default-debian-7.5" => {
      :hostname => "debian-7.5",
      :box => "default-debian-7.5",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-78b45610", # you must subscribe to and manually
      # launch this image once in AWS Marketplace at https://aws.amazon.com/marketplace/pp/B00AA27RK4/ref=srh_res_product_title?ie=UTF8&sr=0-2&qid=1411417674042
      :ssh_username => "admin"
      },
    "default-debian-7.5-i386" => {
      :hostname => "debian-7.5-i386",
      :box => "default-debian-7.5-i386",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-7ab45612", # you must subscribe to this image in AWS Marketplace
      # launch this image once in AWS Marketplace at https://aws.amazon.com/marketplace/pp/B00AA289LU/ref=srh_res_product_title?ie=UTF8&sr=0-3&qid=1411417696908
      :ssh_username => "admin"
      },
    "default-debian-7.6" => {
      :hostname => "debian-7.6",
      :box => "default-debian-7.6",
      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
      :instance_type => "m1.medium",
      :ami => "ami-00a15868",
      :ssh_username => "admin"
      }
#    "default-centos-65-i386" => {
#      :hostname => "centos-65-i386",
#      :box => "default-centos-65-i386",
#      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
#      :instance_type => "m1.medium",
#      :ami => "",# you must subscribe to and manually
      # launch this image once in AWS Marketplace at https://aws.amazon.com/marketplace/pp/B00K1LOEXC/ref=srh_res_product_title?ie=UTF8&sr=0-2&qid=1411417477743
#      :ssh_username => "admin"
#      },
#    "default-centos-65" => {
#      :hostname => "centos-65",
#      :box => "default-centos-65",
#      :box_url => "https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box",
#      :instance_type => "m1.medium",
#      :ami => "",# you must subscribe to and manually
      # launch this image once in AWS Marketplace at https://aws.amazon.com/marketplace/pp/B00IOYDTV6/ref=srh_res_product_title?ie=UTF8&sr=0-2&qid=1411417630958
#      :ssh_username => "admin"
#      }
  }
}

def need_privilege(machine_name)
  if machine_name == 'default-centos-65' || machine_name == 'default-centos-65-i386'
    return false
  else
    return true
  end
end

VAGRANTFILE_API_VERSION = "2"
PROV_SWITCH = ENV['DCM_AGENT_TEST_PROVISIONER']
AGENT_DOCKER_INSTALL = ENV['AGENT_DOCKER_INSTALL'] || 'null'


if PROV_SWITCH == "vb"
  Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
    config.vm.synced_folder "../bin/", "/agent/bin"
    config.vm.synced_folder "../src/", "/agent/src"
    vagrant_root = File.dirname(__FILE__)
    vagrant_root = File.dirname(vagrant_root)
    config.vm.synced_folder "../", vagrant_root
    machine_map = machine_config[PROV_SWITCH]

    machine_map.each do |key, value|
      machine_name = key
      machine_values = value
      config.vm.box_url = machine_values[:box_url]
      config.vm.hostname = machine_values[:hostname]
      config.vm.box = machine_values[:box]

      config.vm.define machine_name do |vm_config|

        vm_config.vm.provider :virtualbox do |v, override|
          override.vm.box_url = machine_values[:box_url]
          override.vm.hostname = machine_values[:hostname]
          override.vm.box = machine_values[:box]
          v.customize [ "createhd", "--filename", machine_values[:disk_path], "--size", 1000 ] 
          v.customize ['storageattach', :id,
                       '--storagectl', machine_values[:second_controller],
                       '--port', 1,
                       '--device', 0,
                       '--type', 'hdd',
                       '--medium', machine_values[:disk_path]]
          v.memory = 2048
        end


        vm_config.vm.provision :shell do |shell|
          if AGENT_DOCKER_INSTALL != "null"
            shell.inline = "sudo bash  /vagrant/agent_docker.sh"
          else
            shell.inline = "sudo /vagrant/test-distro.sh $1 $2 $3"
            shell.args = ["#$ES_STORAGE_CREDS", "#$DCM_AGENT_PKG", "#$DCM_AGENT_VERSION", "#$DCM_AGENT_TEST_LOCAL"]
          end

        end
      end
    end   
  end


elsif PROV_SWITCH == "aws"
  Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
    config.vm.synced_folder ".", "/vagrant", disabled: true
    machine_map = machine_config[PROV_SWITCH]

    machine_map.each do |key, value|
      machine_name = key
      machine_values = value
      config.vm.box_url = machine_values[:box_url]
      config.vm.hostname = machine_values[:hostname]
      config.vm.box = machine_values[:box]

      config.vm.define machine_name do |vm_config|

        vm_config.vm.provider :aws do |aws, override|
          aws.access_key_id = ENV['AWS_ACCESS_KEY']
          aws.secret_access_key = ENV['AWS_SECRET_ACCESS_KEY']
          aws.keypair_name = ENV['AWS_SSH_KEY_ID']
          aws.instance_type = machine_values[:instance_type]
          aws.ami = machine_values[:ami]
          override.ssh.username = machine_values[:ssh_username]
          override.ssh.private_key_path = ENV['AWS_SSH_KEY_PATH']
        end
        vm_config.vm.provision :shell do |mk|
          mk.privileged = need_privilege(machine_name)
          mk.inline = 'mkdir /prov &&
                       chmod -R 777 /prov'
        end

        vm_config.vm.provision :file do |file|
          file.source = "envs" # environment variables
          file.destination = "/prov/envs"
        end

        vm_config.vm.provision :file do |file|
          file.source = "creds" #storage provider creds
          file.destination = "/prov/creds"
        end

        vm_config.vm.provision :shell do |mc|
          mc.privileged = need_privilege(machine_name)
          if AGENT_DOCKER_INSTALL != "null"
            mc.path = "../bin/agent_docker.sh"
          else
            mc.path = "install_agent_test.sh"
          end

        end
      end
    end
  end

elsif PROV_SWITCH == "gce"
  Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
    config.vm.box_url ="https://github.com/mitchellh/vagrant-google/raw/master/google.box"
    config.vm.box = "gce"
    
    config.vm.provider :google do |google, override|
      google.google_project_id = ENV["GCE_PROJECT_ID"]
      google.google_client_email = ENV["GCE_CLIENT_EMAIL"]
      google.google_key_location = ENV["GCE_KEY_LOCATION"]

      override.ssh.username = ENV["USER"]
      override.ssh.private_key_path = ENV["GCE_PRIVATE_KEY_PATH"]
    end

    config.vm.provision :shell do |shell|
      shell.privileged = true
      shell.path = "agent_docker.sh"
    end
  end


else
  puts 'You have to set DCM_AGENT_TEST_PROVISIONER to vb,gce, or aws'
  exit
end
 
